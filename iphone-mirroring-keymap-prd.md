# Product Requirements Document: macOS iPhone Mirroring 单指按键映射/时间片触控调度（荒野行动 FPS）

**Version**: 2.0  
**Date**: 2026-01-16  
**Author**: Sarah（Product Owner）  
**Quality Score**: 92/100  

---

## Executive Summary

本产品是一款运行在 macOS 上的“按键映射/触控模拟”工具：在用户使用 macOS 自带 **iPhone Mirroring（macOS Tahoe 26.2）** 玩《荒野行动》（FPS）时，将键盘/鼠标输入实时转换为镜像窗口内的**单指触控序列**（点击、按住松开、按住拖动松开），以实现更接近 PC FPS 的操控体验。

关键约束：iPhone Mirroring 在 macOS 侧仅表现为“鼠标光标 + 单点按下/拖动/松开”的交互通道（即“一个鼠标 = 一根手指”）。因此本产品采用 **时间片触控调度器（Time-Sliced Touch Scheduler）**：在“摇杆移动意图（WASD）/视角转动意图（鼠标 Δ）/按钮动作（开火/开镜等）”之间以高频切换并做平滑/限速，尽可能在体感上接近 FPS 的“移动 + 转向 + 开枪”同时成立（但不会宣称为真实多指并发）。

产品提供：
- **视角锁定键（CapsLock）**：开启后自动“按住视角锚点”以便鼠标移动驱动转向；关闭后抬起视角，鼠标恢复自由移动且不再进行任何坐标映射（除滚轮滑动外）。
- **背包按键（默认 Tab）**：打开背包时自动关闭视角锁定并释放触控，允许用户自由点选；关闭背包时自动重新开启视角锁定回到战斗。
- **坐标辅助录入/校准**：所有坐标以 **macOS 桌面全局屏幕坐标系（px）** 为准进行设置与保存（非窗口内相对坐标），用户可自行适配游戏 HUD 与镜像窗口位置/大小。
- **滚轮滑动**：在“自由鼠标模式”下，把鼠标滚轮映射为“以当前光标位置为起点的上下短拖动”，滚动结束后光标回到拖动前的位置。

为减少视觉疲劳并贴近人手反馈，所有拖动类动作必须避免“瞬移/阶梯感”，以连续轨迹与限速/插值实现更丝滑的移动。

重要说明：本 PRD 只覆盖 **1:1 输入映射与必要的触控模拟**，不包含自动压枪/自动瞄准等“获取不公平优势”的自动化能力。

---

## Problem Statement

**Current Situation**：
- 使用 iPhone Mirroring 玩 FPS 时，原生仅有鼠标/单点交互，难以同时完成移动、转向、射击等多操作；操控不符合 FPS 肌肉记忆。
- 游戏 HUD 坐标与窗口缩放变化会导致固定点击位置失效，缺少可用的坐标校准工具。

**Proposed Solution**：
- 提供 macOS 桌面端按键映射工具，捕获键鼠输入并向系统投递**合成鼠标/触控等效输入事件**（由 iPhone Mirroring 接收），支持：
  - 点击（Tap）
  - 按住→松开（Hold/Release）
  - 按住→拖动→松开（Drag Hold/Move/Release）
- 在“单指限制”下，通过**时间片调度**在摇杆/视角/按钮动作间切换，以近似实现移动 + 视角 + 射击的体感并行（可配置优先级与时间片参数）
- 提供可视化“坐标点选录入”与校准流程，用户自行配置摇杆中心、半径、射击/开镜坐标、视角锚点等。
- 提供清晰的“模式/状态机”：视角锁定（战斗）/自由鼠标（UI/背包）/暂停（失焦或禁用）三种状态下输入吞吐与输出规则明确可验收。

**Business Impact**：
- 提升 iPhone Mirroring 玩 FPS 的可玩性与操控一致性，降低上手成本，减少误触与“卡手指”问题。

---

## Success Metrics

**Primary KPIs（可通过本地日志/自测工具测量）**：
- **输入到触控延迟（P95）**：≤ 35ms（键鼠事件时间戳 → 触控事件发出时间戳）
- **触点稳定性**：30 分钟游戏过程中“触点卡住（未按键仍按住）”次数 = 0
- **配置效率**：首次配置（从打开软件到可进游戏移动+转向+射击）≤ 5 分钟
- **坐标准确性**：点选录入后误差 ≤ 3px（以 macOS 屏幕坐标系计）
- **轨迹连续性**：所有拖动类动作不得出现单帧大跳变（默认单帧位移上限可配置），肉眼观感无明显“阶梯感”
- **时间片可用性（近似并发）**：
  - 视角锁定开启且鼠标持续移动时：视角拖动输出的“服务间隔（P95）”≤ 20ms（等价 ≥ 50Hz），且无明显抖动
  - WASD 持续按住时：摇杆输出的“服务间隔（P95）”≤ 50ms（等价 ≥ 20Hz），且体感移动不断档（允许极短切换导致的微小断续）
  - 鼠标按键触发（开火/开镜）：“触发延迟（P95）”≤ 25ms
- **自由鼠标模式可用性**：滚轮滑动结束后 80ms 内光标必须恢复到拖动前位置（误差 ≤ 2px）

**Validation**：
- 内置“触点可视化调试层 + 事件日志导出”，用于功能验收与回归测试。

---

## User Personas

### Primary：FPS 进阶玩家（键鼠习惯）
- **Role**：重度 FPS 玩家，追求键鼠操控一致性
- **Goals**：WASD 移动、鼠标转向、鼠标按键射击/开镜的稳定映射；可快速适配不同 HUD
- **Pain Points**：镜像交互限制、难以多操作并行；坐标不准导致误触；窗口缩放/分辨率变化后配置失效
- **Technical Level**：中级（能理解权限授予、配置坐标）

### Secondary：内容创作者/主播
- **Goals**：稳定展示与可重复的操控配置；需要快速切换配置（不同枪械/灵敏度/布局）
- **Pain Points**：直播时卡键、触点残留、配置丢失导致中断

---

## 模式与状态机（核心）

为满足“战斗时像 FPS 一样操作、背包/菜单时鼠标可自由点选”的目标，产品必须实现清晰且可验收的状态机：

### 状态定义
- **暂停/禁用**：映射禁用或目标窗口非前台激活；不投递任何合成操作，且必须释放所有按住并恢复鼠标指针
- **战斗态（视角锁定 ON）**：映射启用 + 目标窗口前台激活 + CapsLock 逻辑开启 + 背包关闭
  - 鼠标移动用于驱动视角（累积阈值 + 平滑后输出）
  - WASD 产生摇杆移动意图
  - 左键 Tap 开火坐标、右键 Tap 开镜坐标
  - 输入默认吞掉（除白名单控制键）
- **自由鼠标态（视角锁定 OFF 或背包打开）**：
  - 鼠标行为保持默认（可自由移动与点选），不得触发任何坐标点操作（摇杆/视角/开火/开镜/自定义等）
  - 仅允许滚轮滑动映射（Story 4）：以光标所在位置为起点短拖动，结束回位

### 状态切换规则
- **CapsLock**：在“映射启用 + 目标窗口前台激活 + 背包关闭”条件下切换战斗态/自由鼠标态
- **背包键（默认 Tab）**：
  - 打开背包：强制进入自由鼠标态（关闭视角锁定并释放按住），并 Tap `I(x,y)`
  - 关闭背包：Tap `I(x,y)`，然后强制回到战斗态（自动开启视角锁定）
- **失焦/禁用/紧急停止**：强制进入暂停/禁用态，并清空背包/锁定等内部状态

## User Stories & Acceptance Criteria

### Story 1：WASD 映射左摇杆（拖动保持）
**As a** FPS 玩家  
**I want to** 用 WASD 控制左摇杆移动（按住即持续移动，松开停止）  
**So that** 我能像 PC FPS 一样移动

**Acceptance Criteria：**
- [ ] 摇杆映射仅在“映射启用 + 目标窗口前台激活 + 视角锁定（CapsLock）开启 + 非背包/自由鼠标模式”时生效；否则不得投递摇杆触控
- [ ] 支持摇杆中心点 `C(x,y)`（屏幕坐标）与半径 `R` 配置，WASD 组合可形成 8 方向向量（含 `W+A` 等斜向）
- [ ] （新增）摇杆触点支持落点随机化 `Rrand`（默认继承全局 `RrandDefault`）：触点 Down 时对摇杆中心 `C` 生成本次中心 `C'`，本次按住周期内固定
- [ ] 任意移动键按下：生成/维持“摇杆触点”按住，并移动到 `C + v*R`（若启用随机化则使用 `C' + v*R`）
- [ ] 移动键组合变化：不抬起触点，仅更新触点位置（Move），且从旧目标到新目标必须“丝滑过渡”（见下条）
- [ ] 摇杆触点位置更新不得瞬移：从当前位置到目标点采用平滑插值/限速策略（例如：低通滤波或分段 Move），默认过渡时间 `τ=60ms`（可配置），并保证输入释放时可立即回中/抬起
- [ ] 所有移动键松开：触点回到 `C`（可配置是否回中；若启用随机化则回到 `C'`），随后抬起（Up）
- [ ] （单指限制说明）在“视角锁定”开启时，系统存在单指输出限制：摇杆触点可能被“视角服务/按钮 Tap”等高优先级动作短暂打断（表现为摇杆 Up→Down 重新落点）。产品必须通过时间片调度与服务间隔指标（见 Success Metrics）将打断控制到体感可接受范围内
- [ ] 应用失焦/目标窗口失效时：立即抬起全部触点，防止“卡住”

### Story 2：视角锁定模式（CapsLock 开关）
**As a** FPS 玩家  
**I want to** 使用 CapsLock 开关“视角锁定”，锁定时用鼠标移动驱动触控拖动转向；解锁时鼠标恢复自由控制  
**So that** 我能在战斗与 UI 操作之间快速切换，并保持视角控制稳定

**Acceptance Criteria：**
- [ ] 触发键：CapsLock（可配置为其他键，但默认 CapsLock）
- [ ] 开启条件：仅在“映射启用 + 目标窗口前台激活 + 非背包/自由鼠标模式”时允许开启；否则 CapsLock 不得导致任何合成事件投递
- [ ] 开启视角锁定：在固定锚点 `A(x,y)`（屏幕坐标；若启用随机化则使用 `A'`）生成“视角按住”状态（逻辑上为 Down），用于驱动转向
- [ ] 视角输入：鼠标移动产生 `Δx,Δy`，先累积到 `accX/accY`；当 `|acc|` 超过阈值 `Tcam`（默认 3px，可配置）时，才生成一次或多次“视角拖动服务”（将累积量按灵敏度系数映射为触控拖动位移并消耗累积量）
- [ ] 视角 Move 必须平滑：对输入 `Δ` 做限速/滤波或时间插值，保证轨迹连续且低延迟（不出现明显抖动与阶梯感）；并限制最大拖动半径 `Rcam`（可配置）
- [ ] 关闭视角锁定：立即释放视角按住（Up），停止视角映射；同时恢复鼠标指针可见与可移动（解除任何锁定/隐藏）
- [ ] 模式约束：当视角锁定关闭时，产品不得进行任何“坐标点操作”（包括摇杆、开火/开镜、自定义按钮等），仅允许 Story 4 的滚轮滑动（以光标所在位置为起点）
- [ ] （单指限制说明）当视角锁定开启且需要摇杆/按钮动作时，产品允许短暂中断视角按住以服务其他动作；但必须在完成后自动恢复视角按住，并满足服务间隔指标（避免明显卡顿）
- [ ] 失焦/禁用/紧急停止：必须立即释放视角按住并恢复鼠标指针（防止卡在锁定状态）

### Story 3：鼠标按键映射射击/开镜
**As a** FPS 玩家  
**I want to** 用鼠标左键射击、右键开镜  
**So that** 我能完成常用战斗操作

**Acceptance Criteria：**
- [ ] 生效条件：仅在“视角锁定开启”时生效；视角锁定关闭时，鼠标左/右键不得触发任何坐标点击（应恢复为自由鼠标行为）
- [ ] 左键点击：在射击坐标 `F(x,y)`（屏幕坐标）执行一次 Tap（Down+Up，按压时长可配置，默认 30ms）
- [ ] 右键点击：在开镜坐标 `S(x,y)`（屏幕坐标）执行一次 Tap（默认用于开镜/关镜；可选支持“按住开镜”模式）
- [ ] （新增）射击/开镜坐标支持随机点按半径 `Rrand`（默认继承全局 `RrandDefault`）：每次按下在半径内生成本次落点 `P'`，一次按住周期内 Down/Up 使用同一 `P'`
- [ ] （单指限制说明）执行 Tap 时允许短暂中断视角/摇杆服务，但必须确保 Tap 触发可靠，且结束后自动恢复到“视角锁定”的默认状态

### Story 4：鼠标滚轮映射滑动（按住拖动，停止抬起）
**As a** 玩家  
**I want to** 通过鼠标滚轮在当前鼠标位置触发手指上下滑动  
**So that** 我能在游戏内的菜单/列表/背包等界面快速滚动

**Acceptance Criteria：**
- [ ] 生效条件：仅在“视角锁定关闭（自由鼠标/背包模式）”时生效；视角锁定开启时滚轮不应触发坐标拖动（可配置为忽略或透传）
- [ ] 当检测到滚轮上/下滚动时，以当前鼠标指针在屏幕坐标系下的坐标 `P(x,y)` 作为起点：若“滚轮拖动”未激活，则生成一次 Down
- [ ] （新增）滚轮触点支持落点随机化 `Rrand`（默认继承全局 `RrandDefault`）：触点 Down 时以 `P(x,y)` 为圆心生成本次起点 `P'`，本次滚动周期内固定
- [ ] 每次滚动按照可配置的距离 `D` 执行 Move（上滚/下滚对应 `y - D` / `y + D`，支持方向反转），默认 `D=8px`
- [ ] 每次滚动的位移不得“瞬移”到目标点：需在一个短时窗口内输出多个 Move（例如 20~60ms），让滚动观感更自然
- [ ] 连续滚动期间保持同一“滚轮拖动”生命周期，不重复触发 Down/Up（避免抖动）
- [ ] 当 `T` ms 内未收到新的滚轮事件则判定“滚动停止”，自动触发 Up（`T` 可配置，默认 120ms）
- [ ] 滚动结束（Up）后：鼠标光标必须恢复到滚动开始前的位置 `P0`（误差 ≤ 2px），避免打断用户指向

### Story 5：坐标辅助录入（点选取屏幕坐标）
**As a** 玩家  
**I want to** 进入编辑模式，在 iPhone Mirroring 窗口内点击以获取坐标  
**So that** 我能快速配置摇杆/按钮位置

**Acceptance Criteria：**
- [ ] 提供“编辑模式”入口，进入后显示十字准星/取点提示
- [ ] 用户在目标 iPhone Mirroring 窗口中点击一次：记录并展示 `x,y`（以 macOS 桌面全局屏幕坐标系计）
- [ ] 坐标以“屏幕坐标”为准保存；若目标窗口位置/尺寸发生变化导致点击命中风险升高，必须在 UI 提示用户重新校准或固定窗口位置（不自动改写坐标）
- [ ] 提供“测试按钮”让用户立即验证该坐标是否点中目标（触发一次 Tap）

### Story 6：游戏模式一键启停与紧急释放
**As a** 玩家  
**I want to** 一键启用/禁用映射，并可紧急停止  
**So that** 我在异常时不会被卡住输入

**Acceptance Criteria：**
- [ ] 提供全局“启用/禁用映射”开关（禁用时不投递任何合成触控）
- [ ] 禁用映射时：必须释放所有按住（Up），并强制关闭视角锁定逻辑状态，恢复鼠标指针可见与可移动
- [ ] 提供“紧急停止”热键：立即抬起所有触点并停止投递；若处于任何鼠标锁定/隐藏/warp 控制状态，必须恢复鼠标指针可见与可移动
- [ ] 状态在 UI 明确可见（启用中/禁用中/失去目标窗口/权限不足）

### Story 7：手动配置档/阶段切换（不按时间自动切换）
**As a** 玩家  
**I want to** 为不同武器/场景保存不同的“手感参数档”，并可手动切换（必要时细分为多个阶段）  
**So that** 我能在不改变 1:1 输入映射的前提下，快速切换到更合适的操作手感

**Acceptance Criteria：**
- [ ] 支持创建/编辑/删除多个配置档（例如：武器 A、武器 B），每个档独立保存视角灵敏度、平滑参数、滚轮 `D` 等配置
- [ ] 支持为配置档绑定快捷键（例如 `F1~F8`）进行手动切换，并在 UI 显示当前激活档名
- [ ] （可选）同一配置档内支持“阶段 1..N”参数组，但阶段切换必须由用户手动触发（例如快捷键循环/指定阶段键），不得根据时间自动切换
- [ ] 支持一键“重置到默认阶段”（例如阶段 1），用于避免状态漂移

### Story 8：背包按键（打开暂停视角、关闭恢复视角）
**As a** 玩家  
**I want to** 使用一个“背包按键”来打开/关闭背包，并在打开背包时自动暂停视角控制、关闭背包后自动恢复  
**So that** 我在背包/菜单界面能用鼠标自然点选，同时回到战斗时不需要手动再切回视角控制

**Acceptance Criteria：**
- [ ] 提供默认“背包按键”（默认 `Tab`，可配置）与背包按钮坐标 `I(x,y)`（屏幕坐标）
- [ ] 打开背包（按下背包按键）：
  - [ ] 若视角锁定原本开启：必须立即关闭视角锁定并释放视角按住（Up），恢复鼠标指针可见与可移动（解除任何锁定/隐藏）
  - [ ] 对 `I(x,y)` 执行一次 Tap（用于打开背包；可选随机点按半径 `Rrand`，默认继承全局 `RrandDefault`）
  - [ ] 进入“背包打开（自由鼠标）”状态：此时不得进行摇杆/视角/开火/开镜等坐标映射（仅允许滚轮滑动 Story 4）
- [ ] 关闭背包（再次按下背包按键）：
  - [ ] 对 `I(x,y)` 再执行一次 Tap（用于关闭背包；可选随机点按半径 `Rrand`，默认继承全局 `RrandDefault`）
  - [ ] 自动开启视角锁定（等价于打开 CapsLock 逻辑状态）：回到战斗态；如配置了视角锚点 `A(x,y)`，系统应恢复到“视角默认按住”的逻辑状态
- [ ] 背包状态的切换必须幂等：快速连按不得导致卡住（例如锁定状态与背包状态冲突）
- [ ] 任意“紧急停止/禁用映射/失焦”时必须清除“视角暂停（背包）/恢复待定”状态并抬起所有触点

### Story 9：自定义按键（可增删、可命名、可取点）
**As a** 玩家  
**I want to** 在编辑界面中自行添加/删除更多“按键→触控动作”的映射，并手动为每个映射标注名称  
**So that** 我能把跳跃、蹲伏、换弹等其他操作按个人习惯绑定到键盘/鼠标上

**Acceptance Criteria：**
- [ ] 生效条件：仅在“视角锁定开启（战斗态）”时允许触发自定义映射；视角锁定关闭/背包态不得触发任何自定义坐标操作
- [ ] 提供“自定义按键列表”界面：显示每条映射的名称、触发键、动作类型、坐标信息、启用状态
- [ ] 支持新增映射，新增时必须可配置：
  - [ ] 名称（用户输入，默认可自动生成如“自定义 1”，可随时改名）
  - [ ] 触发键（键盘按键/鼠标按键；录入方式为“点击后按下要绑定的键”）
  - [ ] 动作类型：Tap / Hold-Release / Drag-Hold（Down→平滑 Move→保持，松开 Up）
  - [ ] 坐标：通过编辑模式点选录入（屏幕坐标）；Drag-Hold 需要起点与终点
  - [ ] 可选参数：Tap 按压时长、Drag 过渡时间等（复用全局平滑策略并允许单项覆盖）
  - [ ] （新增）Tap / Hold-Release / Drag-Hold 支持“随机点按半径”`Rrand`（默认继承全局 `RrandDefault`；全局默认 `0px` 关闭）：每次触发以配置点为圆心在半径内随机生成落点 `P'`；一次按住周期内 Down/Move/Up 必须使用同一组随机结果（Drag-Hold 对起点/终点分别随机且在一次按住周期内固定）
- [ ] 支持删除映射（需二次确认），删除后不再触发任何合成事件投递
- [ ] 支持随时改名，改名不影响绑定关系与配置档引用
- [ ] 若用户将同一触发键绑定到多条映射：必须给出冲突提示，并要求用户选择“替换/取消/保留但禁用其中一条”
- [ ] 自定义映射必须遵循全局安全规则：失焦/紧急停止/禁用映射时立即抬起相关触点，避免残留

---

## Functional Requirements

### Core Features

**1）目标窗口选择与绑定**
- Description：识别并绑定 iPhone Mirroring 窗口（可手动选择，或自动匹配窗口标题/进程）
- User flow：
  1. 首次启动 → 引导选择目标窗口
  2. 绑定成功 → 进入配置/游戏模式
- Edge cases：
  - 窗口关闭/重启/标题变化 → 自动进入“暂停投递”并提示重绑定
  - 窗口位置/尺寸变化 → 提示用户坐标以屏幕坐标保存，建议固定窗口位置或重新校准
- Error handling：绑定失败时不允许启用映射，提示原因与解决方案

**2）键鼠输入捕获**
- Description：捕获键盘按下/松开、鼠标按键、鼠标移动（Δ）、鼠标滚轮（Δ）事件
- Constraints：需要 macOS 权限（辅助功能/输入监控等），必须提供授权引导与自检
- Error handling：权限缺失时禁用相关功能并给出系统设置路径提示
- Input routing：
  - 当“映射禁用”或“目标窗口未前台激活”时：不吞输入（系统行为保持默认），且必须释放所有按住（Up）并恢复鼠标状态
  - 当“映射启用 + 目标窗口处于前台激活”时，按模式决定吞吐策略：
    - 视角锁定开启（战斗态）：
      - 键盘：默认吞掉所有键盘事件（含修饰键组合），避免触发系统快捷键与其他应用行为；但必须保留白名单热键可用（启停/紧急停止/背包等）
      - 鼠标：吞掉鼠标移动/按键事件，并由本工具将其映射为“视角服务 / 开火 Tap / 开镜 Tap”等合成操作；滚轮默认透传或忽略（可配置）
    - 视角锁定关闭（自由鼠标/背包态）：
      - 键盘：不吞（除白名单控制键外），避免影响用户在 UI/背包内正常输入
      - 鼠标：不吞左/右键与移动（恢复自由鼠标）；仅当启用“滚轮滑动映射”时吞掉滚轮事件并转换为 Story 4 的短拖动

**3）单指触控调度引擎（时间片）**
- Description：在“一个鼠标 = 一根手指”的约束下，提供一个调度器将多个输入意图（摇杆/视角/按钮/滚轮）以时间片方式串行投递为单指触控序列
- Core model：
  - 逻辑层（并发）：同时维护多个“意图状态”：
    - 摇杆意图：`v`（由 WASD 组合得到的方向向量）+ 中心 `C` + 半径 `R`
    - 视角意图：鼠标累积 `accX/accY` + 锚点 `A` + 阈值 `Tcam` + 半径 `Rcam` + 灵敏度/反转
    - 按钮意图：开火/开镜/背包等 Tap 请求队列（或可选 Hold 模式）
    - 滚轮意图：滚动会话（起点 `P0`、当前目标、停止抬起阈值 `T`）
  - 输出层（串行）：任意时刻只能存在 0 或 1 个“物理按住”（鼠标 Down）；所有其他意图必须通过“短暂中断 + 服务 + 恢复”的方式实现
- Scheduler requirements：
  - 调度频率：可配置 Tick（建议默认 120Hz；可选 60~240Hz）
  - 优先级：必须可配置；默认建议为 视角服务 > 按钮 Tap（开火/开镜） > 摇杆服务 > 其他（滚轮/自定义）
  - 服务间隔：必须记录并暴露指标（用于验收 Success Metrics），并在接近超时时提升对应意图优先级（deadline/aging）
  - 视角服务：采用“累积阈值触发 + 平滑插值”输出短拖动段；避免每个微小 Δ 都打断其他服务
  - 摇杆服务：在视角锁定开启时，允许短暂获得时间片进行摇杆拖动；允许因单指限制导致的 Up→Down 重新落点，但必须控制到体感可接受范围
  - 按钮 Tap：必须可靠；允许打断视角/摇杆，但 Tap 结束后必须自动恢复到“视角锁定”的默认状态
- Mouse pointer policy：
  - 视角锁定开启：鼠标指针可被隐藏并锁定/回拉到安全位置（避免撞到屏幕边缘）；退出锁定时必须恢复到进入锁定前的位置与可见性
  - 自由鼠标/背包态：不锁定指针；滚轮滑动映射结束后必须把光标恢复到滚动开始前的位置 `P0`
- Safety：
  - 任意“紧急停止/禁用映射/目标窗口失效/失焦”时，必须立即执行一次“全量释放”（确保 mouseUp 已发出）并清空所有意图状态（包括滚轮会话、背包状态、视角锁定逻辑状态）

**4）映射类型**
- Tap：单击坐标（Down+Up，间隔可配置；支持落点随机化 `Rrand`）
- Hold/Release：按下生成 Down，松开生成 Up（支持落点随机化 `Rrand`；一次按住周期内 Down/Up 使用同一落点）
- Drag Hold/Move/Release：按下生成 Down 并 Move 到目标；松开 Up（支持落点随机化 `Rrand`；对起点/终点分别随机，且各自在一次按住周期内固定）
- Wheel Swipe：滚轮驱动的上下滑动（**仅自由鼠标/背包态**生效）：以当前鼠标位置 Down，按 `D` 生成短时连续 Move，滚动停止 Up；滚动结束光标恢复到滚动前位置（支持 `Rrand`）
- Joystick：由 WASD 向量驱动的“摇杆服务”（**仅视角锁定开启**生效）：以中心 `C` 与半径 `R` 计算目标点并进行短时拖动服务（支持 `Rrand`）；受单指限制影响，可能发生短暂 Up→Down 重入
- Camera Lock（CapsLock）：视角锁定开关（**CapsLock**）：以锚点 `A` 为中心，对鼠标 Δ 做累积阈值与平滑后输出短拖动段（支持 `Rrand`）

**落点随机化（Randomized Touch Point）**
- 目的：更贴近人类触控行为的“落点不完全一致”
- 参数：随机半径 `Rrand`（单位 `px`，`0px` 表示关闭随机化）
- 分布：必须为**圆内面积均匀分布**（非半径均匀分布）
- 规则：每个触点生命周期（Down→…→Up）内，所有引用“本次随机化点”的事件必须使用同一随机结果（避免抖动）；连续 Move 过程不叠加逐帧随机噪声

**坐标体系说明**
- 所有可配置点位（如 `C/A/F/S/I` 及所有自定义映射坐标）均使用 **macOS 桌面全局屏幕坐标系**；运行时若目标窗口位置/尺寸变化，产品只提示风险与重新校准，不自动改写坐标
- 本 PRD 中所有坐标与距离单位统一为 `px`

**5）配置与持久化**
- 支持保存/加载配置文件（本地 JSON/YAML 等），至少包含：
  - 摇杆中心与半径
  - 视角锚点与灵敏度/反转、累积阈值 `Tcam`、视角拖动半径 `Rcam`
  - 射击/开镜坐标（默认 Tap；可选按住/切换）
  - 背包按键与背包坐标 `I(x,y)`（默认 Tab），以及“打开背包自动关闭视角锁定、关闭背包自动开启视角锁定”的开关
  - 滚轮滑动配置（每次拖动距离 `D`、停止抬起阈值 `T`、方向反转）
  - 手感平滑参数（如摇杆过渡时间 `τ`、Move 频率、单帧位移上限、最大速度/加速度上限等）
  - （新增）全局随机半径 `RrandDefault`（默认 `0px` 关闭；作用于所有动作类型的落点随机化，支持被单条映射覆盖）
  - （新增）内置映射的 `Rrand` 覆盖项（例如：摇杆/视角/射击/开镜/背包/滚轮），默认继承 `RrandDefault`
  - 全局热键（启停/紧急停止）；视角锁定键默认 CapsLock（可配置）
- 支持自定义映射列表持久化：每条包含名称、触发键、动作类型、屏幕坐标与参数（如 `Rrand`、Tap 按压时长、Drag 过渡时间等）
- 不提供任何“游戏预置布局/模板”；所有坐标与映射均通过编辑模式由用户手动设置
- 支持多配置档与手动切换（可选阶段参数组，但阶段切换必须手动）



---

## Technical Approach & Architecture（技术路线与架构）

> 本节用于把 PRD 落到可实现的软件架构与关键技术决策，避免“需求正确但实现不可落地/不可验收”。

### 总体技术路线（基于单指限制）

1. **输入侧（捕获 + 吞输入）**：通过系统级事件捕获获取键盘/鼠标/滚轮输入，并在战斗态按规则吞掉事件，避免“双重输入”。
2. **逻辑侧（意图并发）**：并发维护多个意图状态（摇杆向量、视角累积量、按钮 Tap 队列、滚轮会话、背包/锁定状态）。
3. **输出侧（单指时间片）**：以固定 Tick 频率运行调度器，把多个意图“分配时间片”转换为一条单指触控序列（鼠标 Down/Drag/Up + 光标 warp/隐藏/回位）。

### 关键系统 API（建议实现选型）

- **输入捕获/吞输入**：Quartz Event Services `CGEventTapCreate`（键盘、鼠标移动、鼠标按键、滚轮）
- **全局热键（启停/紧急停止/配置档切换可选）**：优先复用 `CGEventTap` 监听；必要时使用 Carbon `RegisterEventHotKey`
- **鼠标注入（触控等效）**：`CGEventCreateMouseEvent` + `CGEventPost(.cghidEventTap)`
- **光标控制**：
  - `CGWarpMouseCursorPosition`（把光标“虚拟移动”到指定坐标以命中触点）
  - `CGDisplayHideCursor/ShowCursor`（战斗态隐藏/退出恢复）
  - `CGAssociateMouseAndMouseCursorPosition(false/true)`（可选：战斗态将“物理鼠标移动”与“光标位置”解耦，实现“用户感知不移动光标”，退出战斗态必须恢复关联）
- **目标窗口发现/绑定**：`CGWindowListCopyWindowInfo`（列举窗口 + bounds + pid）；运行时结合 `NSWorkspace` 判断前台 app
- **权限**：
  - 辅助功能（Accessibility）：用于发送/控制鼠标事件
  - 输入监控（Input Monitoring / Listen Event）：用于捕获键盘/鼠标事件（event tap / global monitor）

### 架构分层与模块划分

- **UI 层（SwiftUI）**
  - 配置页：坐标取点、半径/阈值/灵敏度、开火/开镜/背包坐标、滚轮参数、随机半径、档位管理
  - 状态栏/主界面：当前模式（暂停/战斗/自由鼠标/背包）、目标窗口状态、权限状态、运行指示
- **配置层（Config）**
  - `Profile`：一套完整参数（摇杆/视角/按钮/滚轮/调度器参数）
  - `Settings`：全局开关、热键、目标窗口绑定信息、当前激活 Profile
  - 本地持久化：JSON（带版本号与迁移策略）
- **输入层（InputCapture）**
  - EventTap 管理：安装/卸载、事件回调、吞输入策略
  - 事件去抖与过滤：忽略本应用注入导致的回流事件（防止 feedback loop）
- **状态机（ModeStateMachine）**
  - 输入：CapsLock、背包键、启停/紧急停止、目标窗口前台状态
  - 输出：当前模式（战斗/自由鼠标/暂停），以及“是否允许映射/吞输入”
- **意图引擎（IntentEngine）**
  - 摇杆意图：WASD → 向量 `v`（归一化）+ 目标点 `C + v*R`
  - 视角意图：鼠标 Δ 累积 `accX/accY`，阈值触发与消耗（`Tcam`）
  - 按钮意图：Tap 队列（开火/开镜/背包/自定义）
  - 滚轮会话：开始位置 `P0`、当前目标、停止计时器
- **时间片调度器（Scheduler）**
  - Tick（默认 120Hz）：每 Tick 选择一个服务项（视角/摇杆/按钮/滚轮）
  - Deadline/Aging：保障视角与摇杆都有最小服务频率（见 Success Metrics）
  - 视角采用“累积阈值 + 小段拖动”输出，摇杆采用“周期性短拖动服务”维持移动
- **输出注入（Injector）**
  - 原语：warp、down、drag、up、tap、恢复光标
  - 策略：战斗态默认隐藏光标；自由鼠标态不隐藏；滚轮映射结束必须回位
- **诊断与可视化（Diagnostics）**
  - 事件日志：输入事件时间戳、调度决策、输出事件、异常（丢帧/超时/失焦）
  - 调试层（可选 overlay）：显示 C/A/F/S/I 点位与半径、当前模式、最近一次输出服务类型

### 时间片调度算法（必须可配置与可验收）

建议把“并发近似”的质量主要由以下参数控制，并允许用户/档位配置：

- `tickHz`：调度频率（60~240Hz，默认 120Hz）
- `cameraBudgetMs`：视角服务的单次时间片预算（默认 6ms）
- `joystickMinHz`：摇杆最小服务频率（默认 20Hz，即 ≤50ms 必须服务一次）
- `cameraMinHz`：视角最小服务频率（默认 50Hz，即 ≤20ms 必须服务一次）
- `tapPriorityBoostMs`：Tap 请求的抢占窗口（默认 0ms，立即执行）
- `Tcam`：视角累积阈值（默认 3px）

### 线程与时序模型（建议）

- **输入线程**：EventTap 回调只做轻量处理（事件过滤、状态更新、入队），避免阻塞导致系统事件丢失/延迟
- **调度线程**：使用高频 `DispatchSourceTimer`（或等价机制）运行 Scheduler Tick；每 Tick 读最新意图状态并输出 0..N 个合成事件
- **UI 线程**：只订阅状态/指标（当前模式、P95、服务间隔等），不参与实时路径
- **事件回流抑制**：Injector 产生的事件必须带可识别标记（如 `CGEventSetIntegerValueField(...userData...)` 或 `CGEventSource` 配置）并在 InputCapture 侧过滤，避免 feedback loop

## Technical Constraints

### Performance
- 合成事件投递循环不得阻塞 UI；鼠标移动到触点 Move 的处理需稳定低延迟（目标见 Success Metrics）
- 触点 Move 频率可配置并限流（如 60~240Hz），避免过高频导致系统抖动

### Security & Privacy
- 默认离线运行，不上传用户输入与游戏画面
- 配置文件仅保存在本机；提供一键清除配置

### Integration
- 依赖：macOS 自带 iPhone Mirroring 窗口处于可交互状态
- 必须：能够向该窗口投递可被感知为“单指触控”的鼠标等效事件，并在单指限制下通过时间片调度稳定支持：
  - 视角锁定（鼠标 Δ 驱动转向）
  - 摇杆服务（WASD 方向服务）
  - 开火/开镜/背包等按钮 Tap
  - 自由鼠标态滚轮滑动（短拖动 + 光标回位）

### Compatibility
- macOS Tahoe 26.2（最低支持版本待定，需以 iPhone Mirroring 可用版本为准）
- MVP 默认假设 **单显示器**（更符合目标用户场景）；多显示器（含负坐标）支持可作为后续版本增强
- 坐标使用 macOS 全局屏幕坐标系：必须正确处理 Retina 缩放（统一转换为 `px`）

---

## Scope & Non-Goals（范围与非目标）

### In Scope（必须支持）
- iPhone Mirroring 目标窗口绑定 + 前台检测；失焦/窗口失效自动暂停投递并全量释放
- 单指触控调度（时间片）：摇杆（WASD）/视角（鼠标 Δ）/按钮（开火/开镜/背包/自定义）/滚轮滑动（自由鼠标态）在单指约束下稳定工作
- 视角锁定（CapsLock）与背包键（默认 Tab）驱动的状态机：战斗态/自由鼠标态/暂停态规则明确可验收
- 坐标录入与校准：编辑模式点选取屏幕坐标 + 一键测试 Tap；坐标保存为屏幕坐标（不做相对缩放）
- 多配置档（Profile）与手动切换；诊断日志与关键指标可视化（至少本地日志）

### Out of Scope（明确不做）
- 真实多指并发触控（iPhone Mirroring 单鼠标通道限制下不可实现）
- 自动瞄准/自动压枪/自动开火等“提供不公平优势”的游戏自动化能力
- 触控板多指手势专项支持（MVP 以鼠标等效输入处理；不做额外手势体系）
- 依据窗口缩放/分辨率自动换算坐标（仅提示风险与重新校准，不自动改写）
- 云端同步/账号系统/远程配置分发（默认离线本地）

---

## UX / UI Specification（交互与界面规格）

### 首次启动引导（必须有）
1. **权限自检页**：展示“输入监控 / 辅助功能”两项状态；提供跳转系统设置按钮与“重新检测”按钮
2. **目标窗口绑定**：列出可选窗口（包含窗口标题、进程名、窗口预览 bounds）；用户选中 iPhone Mirroring 窗口后保存绑定
3. **基础坐标配置向导**：依次引导用户点选 `C（摇杆中心）/A（视角锚点）/F（开火）/S（开镜）/I（背包）`；每步提供“测试”按钮
4. **进入游戏提示**：提示用户固定 iPhone Mirroring 窗口位置/缩放；提示 CapsLock/Tab 的默认规则

### 常驻控制（建议：菜单栏 + 主窗口）
- **菜单栏图标**：显示当前状态（暂停/战斗/自由鼠标/背包）、当前 Profile、目标窗口有效性、权限状态
- **主窗口 Tab（建议）**：
  - Setup：权限/目标窗口/启停/紧急停止
  - Mapping：内置点位（C/A/F/S/I）与自定义映射列表
  - Profiles：配置档管理与快捷键绑定
  - Diagnostics：实时指标（延迟/服务间隔/丢帧）+ 日志导出

### 编辑模式（取点/校准，必须可用且安全）
- 进入编辑模式时：强制暂停投递与吞输入（避免误触与卡住）
- 取点方式：显示十字准星与坐标提示；用户在 iPhone Mirroring 窗口点击一次即记录屏幕坐标
- 支持“微调”：允许用方向键以 1px/10px 步进调整当前点（可选，但建议支持）
- 退出编辑模式时：不自动开启战斗态；由用户显式点击“启用映射/进入战斗”

### 状态可见性与防误操作（必须明确）
- 战斗态（视角锁定 ON）必须有清晰提示（例如菜单栏高亮/窗口角标）
- 自由鼠标态必须保证左/右键不触发任何坐标操作（仅滚轮映射可选生效）
- 任意时刻可触发紧急停止，且触发后必须立即恢复鼠标可见与可移动

---

## Defaults & Tunables（默认值与可配置参数）

> 目的：让工程实现与验收有“默认手感基线”，同时保留可调空间。

| 参数 | 默认值 | 建议范围 | 说明 |
|---|---:|---:|---|
| `tickHz` | 120 | 60~240 | 调度频率；越高越丝滑但 CPU 更高 |
| `cameraMinHz` | 50 | 30~120 | 视角最小服务频率（服务间隔 P95 目标） |
| `joystickMinHz` | 20 | 10~60 | 摇杆最小服务频率 |
| `cameraBudgetMs` | 6 | 2~10 | 单次视角服务时间片预算 |
| `Tcam` | 3px | 1~10px | 鼠标 Δ 累积阈值，抑制微抖 |
| `Rcam` | 80px | 20~200px | 视角拖动最大半径（或等价限幅） |
| `R` | 120px | 60~200px | 摇杆半径 |
| `τ` | 60ms | 20~120ms | 摇杆方向变化的平滑过渡时间 |
| `tapHoldMs` | 30ms | 10~80ms | Tap 按压时长 |
| `wheelD` | 8px | 4~20px | 每个滚轮事件对应的位移目标 |
| `wheelStopT` | 120ms | 60~250ms | 多久未收到滚轮事件即 Up |
| `RrandDefault` | 0px | 0~12px | 全局随机半径；默认关闭 |
| `maxStepPx` | 6px | 2~12px | 单帧最大位移（限速，避免阶梯/瞬移） |

---

## Config Schema（配置文件结构，建议）

> 目标：可版本化迁移、可导入导出、可用于诊断复现。

```json
{
  "version": 1,
  "targetWindow": { "pid": 1234, "windowId": 5678, "titleHint": "iPhone Mirroring" },
  "global": {
    "enableHotkey": "F8",
    "panicHotkey": "F12",
    "cameraLockKey": "CapsLock",
    "backpackKey": "Tab",
    "rrandDefaultPx": 0
  },
  "profiles": [
    {
      "name": "Default",
      "points": { "C": [100, 200], "A": [500, 300], "F": [900, 600], "S": [980, 600], "I": [950, 80] },
      "joystick": { "radiusPx": 120, "tauMs": 60, "rrandPx": null },
      "camera": { "tcamPx": 3, "radiusPx": 80, "invertY": false, "sensitivity": 1.0, "rrandPx": null },
      "fire": { "mode": "tap", "tapHoldMs": 30, "rrandPx": null },
      "scope": { "mode": "tap", "tapHoldMs": 30, "rrandPx": null },
      "wheel": { "enabled": true, "dPx": 8, "stopMs": 120, "invert": false, "rrandPx": null },
      "scheduler": { "tickHz": 120, "cameraMinHz": 50, "joystickMinHz": 20, "cameraBudgetMs": 6 }
    }
  ],
  "customMappings": [
    { "name": "Use", "key": "E", "type": "tap", "point": [800, 500], "tapHoldMs": 30, "rrandPx": 2 }
  ]
}
```

---

## QA / Validation Plan（验收与测试方案）

### 功能验收（手工为主，必须覆盖）
- 权限：无权限/半权限/全权限下 UI 引导正确；授权后无需重启即可生效（如系统限制则提示）
- 绑定：目标窗口关闭/重启/失焦时自动暂停投递并全量释放；回到前台后需显式恢复（或按规则恢复）
- 状态机：
  - CapsLock 开/关切换战斗/自由鼠标态符合定义
  - Tab 打开背包 -> 强制自由鼠标态 + Tap I；关闭 -> Tap I + 自动回战斗态
- 单指调度：战斗态下 WASD+鼠标移动+左键点击时，体感“移动不断档/转向连续/开火可靠”
- 滚轮：自由鼠标态滚轮触发短拖动且结束回位；战斗态滚轮不触发坐标拖动（按配置忽略/透传）
- 安全：紧急停止后立即抬起所有按住并恢复光标；不出现卡住

### 性能/手感验收（以日志指标为准）
- P95 输入到投递延迟 ≤ 35ms
- `camera` 服务间隔 P95 ≤ 20ms；`joystick` 服务间隔 P95 ≤ 50ms
- 30 分钟持续操作，触点卡住次数 = 0

---

## Risks & Mitigations（风险与降级策略）

- **iPhone Mirroring 行为变化**：系统更新可能改变交互/坐标处理；Mitigation：版本检测 + 兼容性提示 + 快速回滚开关
- **系统权限与安全策略**：EventTap/注入可能受限；Mitigation：权限自检、失败时自动禁用映射并给出明确指引
- **单指时间片导致“断续感”**：Tap 抢占或摇杆/视角争抢造成抖动；Mitigation：累积阈值 `Tcam`、deadline/aging、可配置优先级与最小服务频率
- **系统快捷键冲突（CapsLock/Tab 等）**：Mitigation：允许改键；战斗态吞键；自由鼠标态不吞键
- **坐标漂移（窗口移动/缩放/Retina）**：Mitigation：显式提示固定窗口；提供一键校准与快速测试；坐标统一为 `px`

---

## Milestones（里程碑建议）

- M0（原型）：EventTap 捕获 + Injector Tap/Drag 验证可被 iPhone Mirroring 感知
- M1（MVP）：状态机（CapsLock/Tab）+ 摇杆/视角/开火开镜 + 时间片调度 + 坐标取点
- M2（可用 Beta）：Profile/自定义映射/诊断指标与日志导出 + 参数调优
- M3（发布）：稳定性打磨（卡住=0）、引导完善、配置迁移与导入导出

---

## Open Questions（待确认）

- 开火/开镜是否需要“按住模式”（鼠标按下=Hold，松开=Release）作为可选项？（部分 FPS 更符合肌肉记忆）
- 启停/紧急停止热键默认值与是否允许用户自定义？
- 是否需要“窗口绑定丢失后的自动重绑定策略”（按 pid+titleHint 匹配）还是强制用户手动确认？

---



*This PRD was created through interactive requirements gathering with quality scoring to ensure comprehensive coverage of business, functional, UX, and technical dimensions.*
